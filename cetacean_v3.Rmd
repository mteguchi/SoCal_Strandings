---
title: "R Notebook"
output: html_notebook
---

This document an initial analysis of cetacean strandings along the coast of San Diego county. We are interested in looking at if there is any temporal and spatial patterns of strandings, especially related to military bases. 

v3: Look at the same comparison between SS and non-SS for each species. 

```{r setup}
rm(list=ls())
library(tidyverse)
library(readr)
library(ggplot2)
library(ggridges)
library(sf)
library(ggridges)
#library(viridis)

save.fig <- F

source("SoCal_Strandings_fcns.R")
S.lat <- 32.4
N.lat <- 33.55
W.lon <- -118
E.lon <- -116.8

US.MX.border.lat <- 32.5344
TJriver.lat <- 32.55
SilverStrandN.lat <- 32.69
DogBeach.Nend.lat <- 32.685
Navy.base.S.lat <- 32.6369
Navy.base.N.lat <- 32.6742

W.lon.SS <- -117.35
E.lon.SS <- -117.05
SDB.mouth.lon <- -117.23
N.lat.SS <- 32.73
S.lat.SS <- US.MX.border.lat

col_defs <- cols(Specimen = col_character(),
                 RecoveryConditionID = col_character(),
                 IsSDCounty = col_character(),
                 SpeciesID = col_character(),
                 COMMONNAME = col_character(),
                 GENUS = col_factor(),
                 SPECIES = col_factor(),
                 OriginID = col_character(),
                 OriginDescription = col_character(),
                 SDCountyMapID = col_factor(),
                 Location = col_character(),
                 Year = col_integer(),
                 Month = col_integer(),
                 Day = col_integer(),
                 Latitude = col_double(),
                 Latitude_Precision = col_double(),
                 Latitude_Precision_Unit = col_character(),
                 Longitude = col_double(),
                 Longitude_Precision = col_double(),
                 Longitude_Precision_Unit = col_character())

# remove those with NA entries in lat/lon and San Diego Bay in Location
dat.1 <- read_csv(file = "data/SDCetaStrandings2000_2019.csv",
                  col_types = col_defs) %>% 
  filter(!is.na(Latitude)) %>%
  filter(Location != "San Diego Bay") %>%
  filter(Longitude > -118) %>%       # remove San Clemente stranding
  unite(col = "Sp", GENUS:SPECIES, remove = FALSE)  

# create a spatial object
dat.1 %>% select(Longitude, Latitude, 
                 Specimen, GENUS, SPECIES, COMMONNAME, 
                 SDCountyMapID, Year, Month) %>% 

  st_as_sf(coords = c("Longitude", "Latitude"), 
           crs = "+proj=longlat +datum=WGS84") -> dat.1.sp

```

First look at the area map to orient ourselves. Some lat/lon seemed to be a bit off so went through one year at a time to see which ones needed to be corrected. Lines that are commented out were for that purpose. 

Bring in shapefiles:

```{r}
# get the coast lines
# Does this work with Windows?
home.dir <- Sys.getenv("HOME")
coast.line <- st_read(paste0(home.dir, "/Documents/Oceans and Maps/San Diego/COASTLINE"),
                      layer = "coast") %>% 
  st_transform(crs = "+proj=longlat +datum=WGS84") 

# this is for plotting:
harbor_bay_1 <- st_read(paste0(home.dir, "/Documents/Oceans and Maps/San Diego/Harbor_Bay"), 
                        layer = "Harbor_Bay") %>% 
   st_transform(crs = "+proj=longlat +datum=WGS84") 

# I edited SDB in QGIS on my laptop (linux) so that Silver Strand is not included.
# this is for computing coast length
harbor_bay <- st_read(paste0(home.dir, "/Documents/Oceans and Maps/San Diego/SDB_v2"),
               layer = "SDB_v2") %>% 
  st_transform(crs = "+proj=longlat +datum=WGS84") 

Pacific <-  st_read(paste0(home.dir, "/Documents/Oceans and Maps/San Diego/Pacific_Ocean"), 
                    layer = "PACIFIC_OCEAN") %>% 
  st_transform(crs = "+proj=longlat +datum=WGS84") 

# get county lines
county.lines <- st_read("data/ca-county-boundaries/CA_Counties")

county.lines %>% filter(NAME == "San Diego") %>%
  st_transform(crs = "+proj=longlat +datum=WGS84") -> SD.county.line

# Silver Strand - created from the entire coast line above in QGIS
SS <- st_read(paste0(home.dir, "/Documents/Oceans and Maps/San Diego/SilverStrand"),
               layer = "SilverStrand") %>% 
  st_transform(crs = "+proj=longlat +datum=WGS84") %>%
  st_cast("LINESTRING")

Navy <- st_read(paste0(home.dir, "/Documents/Oceans and Maps/Navy_installations_poly"), 
                layer = "Navy_installations_poly") %>% 
  st_transform(crs = "+proj=longlat +datum=WGS84") %>%
  st_make_valid()  # some duplicated vertices removed. 

# https://gis.stackexchange.com/questions/404385/r-sf-some-edges-are-crossing-in-a-multipolygon-how-to-make-it-valid-when-using/404454


land.color <- "cornsilk" #'#333333'
water.color <- "lightcyan1"
Navy.color <- "salmon"
font.size <- 3.5

```

Exclude those that are found outside of SD county and just Silver Strand:

```{r}
# In San Diego county
# in.SD <- st_join(dat.1.sp, SD.county.line) %>% 
#    filter(!is.na(AWATER)) 

# Just along SS
# dat.1 %>% filter(Latitude < SilverStrandN.lat & 
#                    Latitude > US.MX.border.lat &
#                    Longitude > SDB.mouth.lon) %>% 
#   st_as_sf(coords = c("Longitude", "Latitude"), 
#            crs = "+proj=longlat +datum=WGS84") -> dat.1.SS.sp

```


Simple statistics of # strandings per unit coast length

```{r}
# first, intersection between coast line and county
SD.coast <- st_intersection(coast.line, SD.county.line)

# need to remove Mission Bay and San Diego Bay
# MB - convert polygon to line
harbor_bay %>% filter(NAME == "MISSION BAY") -> MB.poly
MB.line <- st_cast(MB.poly, "LINESTRING")
MB.length <- sum(st_length(MB.line))

# SDB coast length
harbor_bay %>% filter(NAME == "SAN DIEGO BAY") -> SDB.poly
SDB.line <- st_cast(SDB.poly, "LINESTRING")
SDB.length <- sum(st_length(SDB.line))

SD.coast.no.MB.SDB.length <- as.numeric(sum(st_length(SD.coast)) - MB.length - SDB.length)

# Silver Strand coast length
SS.length <- as.numeric(st_length(SS))

# remove Silver Strand strandings
dat.1 %>% filter(Location != "Imperial Beach/Coronado") -> dat.1.noSS
dat.1.noSS %>% st_as_sf(coords = c("Longitude", "Latitude"), 
           crs = "+proj=longlat +datum=WGS84") -> dat.1.noSS.sp 

dat.1 %>% filter(Location == "Imperial Beach/Coronado") -> dat.1.SS
dat.1.SS %>% st_as_sf(coords = c("Longitude", "Latitude"), 
           crs = "+proj=longlat +datum=WGS84") -> dat.1.SS.sp 

# All species combined
dat.1 %>% 
  group_by(Year) %>%
  summarise(n = n(),
            n_per_km = n/((SD.coast.no.MB.SDB.length)/1000),
            Coast = "All") -> stranding.perKm.perYr.all


dat.1.noSS %>% 
  group_by(Year) %>%
  summarise(n = n(),
            n_per_km = n/((SD.coast.no.MB.SDB.length-SS.length)/1000),
            Coast = "No SS") -> stranding.perKm.perYr.noSS

dat.1.SS %>% 
  group_by(Year) %>%
  summarise(n = n(),
            n_per_km = n/((SS.length)/1000),
            Coast = "SS only") -> stranding.perKm.perYr.SS

stranding.perKm.perYr <- rbind(stranding.perKm.perYr.all, 
                               stranding.perKm.perYr.noSS, 
                               stranding.perKm.perYr.SS)
```


Species specific SS vs non-SS
```{r}
# Create species x year combinations
Sp.Year.noSS <- tibble(Year = dat.1.noSS$Year,
                       Sp.f = dat.1.noSS$Sp) %>%
  expand(Year, Sp.f)

Sp.Year.SS <- tibble(Year = dat.1.SS$Year,
                  Sp.f = dat.1.SS$Sp) %>%
  expand(Year, Sp.f)

dat.1.noSS %>% 
  mutate(Sp.f = as.factor(Sp)) %>% 
  group_by(Sp.f, Year) %>%
  summarise(n = n(),
            n_per_km = n/((SD.coast.no.MB.SDB.length-SS.length)/1000),
            Coast = "No SS") %>% 
  right_join(Sp.Year.noSS, 
             by = c("Year", "Sp.f")) %>%
  replace_na(list(n = 0, 
                  n_per_km = 0, 
                  Coast = "No SS")) -> stranding.perSp.perKm.perYr.noSS

dat.1.SS %>% 
  mutate(Sp.f = as.factor(Sp)) %>% 
  group_by(Sp.f, Year) %>%
  summarise(n = n(),
            n_per_km = n/((SS.length)/1000),
            Coast = "SS only") %>% 
  right_join(Sp.Year.SS, 
             by = c("Year", "Sp.f")) %>%
  replace_na(list(n = 0, 
                  n_per_km = 0, 
                  Coast = "SS")) -> stranding.perSp.perKm.perYr.SS

ggplot(data = stranding.perSp.perKm.perYr.noSS) +
  # geom_density_ridges(aes(x = Year, y = Sp.f, height = n_per_km),
  #                     stat = "identity", alpha = 0.5) +
  geom_ridgeline(aes(x = Year, y = Sp.f, height = (n_per_km*10)),
                 alpha = 0.5) +
  #geom_point(aes(x = Year, y = Sp.f), inherit.aes = F, size = 0.3) +

  theme(axis.title = element_blank()) +
  ggtitle("Stranding rate along SD county beach without SS (n/10 km)")

if (save.fig) 
  ggsave(filename = "figures/stranding_perSp_noSS.png",
       device = "png", dpi = 600)
```


```{r}
ggplot(data = stranding.perSp.perKm.perYr.SS) +
  #geom_density_ridges(aes(x = Year, y = Sp.f, height = n_per_km*10),
  #                    stat = "identity", alpha = 0.5) +
   geom_ridgeline(aes(x = Year, y = Sp.f, height = (n_per_km*10)),
                  alpha = 0.5) +

  theme(axis.title = element_blank()) +
  ggtitle("Stranding rate along Silver Strand (n/10 km)")

if (save.fig) 
  ggsave(filename = "figures/stranding_perSp_SS.png",
       device = "png", dpi = 600)
```

